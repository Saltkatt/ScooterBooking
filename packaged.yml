AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'sam-app

  Sample SAM Template for sam-app

  '
Parameters:
  TableName:
    Type: String
    Default: adam-bookings-api-dev-09-08-rc4
  CodeUri:
    Type: String
    Default: target/bookings-api-dev.jar
  UserPoolArn:
    Type: String
    Default: xxx
  UserPoolId:
    Type: String
    Default: xxx
  CognitoUserPoolName:
    Type: String
    Default: MyUserPool
  CognitoUserPoolClientName:
    Type: String
    Default: MyUserPoolClient
Globals:
  Function:
    Timeout: 20
    MemorySize: 1024
    Environment:
      Variables:
        BOOKINGS_TABLE_NAME:
          Ref: TableName
        USER_POOL_ID:
          Ref: UserPoolId
Resources:
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: dev
      Cors: '''*'''
      Auth:
        ApiKeyRequired: false
        DefaultAuthorizer: MyCognitoAuth
        Authorizers:
          MyCognitoAuth:
            UserPoolArn:
              Fn::GetAtt:
              - MyCognitoUserPool
              - Arn
            Identity:
              Header: Authorization
  GetBookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.GetBookingHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: TableName
      Events:
        GetBooking:
          Type: Api
          Properties:
            Path: /bookings/{id}
            Method: get
  ListBookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.ListBookingHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: TableName
      Events:
        GetBookings:
          Type: Api
          Properties:
            Path: /bookings
            Method: get
  ListBookingsByUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.ListBookingsByUserHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBReadPolicy:
          TableName:
            Ref: TableName
      Events:
        GetBooking:
          Type: Api
          Properties:
            Path: /bookings-by-user
            Method: get
  DeleteBookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.DeleteBookingHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TableName
      Events:
        DeleteBooking:
          Type: Api
          Properties:
            Path: /bookings/{id}
            Method: delete
  CreateBookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.CreateBookingHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TableName
      Events:
        CreateBooking:
          Type: Api
          Properties:
            Path: /bookings
            Method: post
  UpdateBookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.UpdateBookingHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TableName
      Events:
        UpdateBooking:
          Type: Api
          Properties:
            Path: /bookings/{id}
            Method: put
  ActivateBookingFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.ActivateBookingHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TableName
      Events:
        ActivateBooking:
          Type: Api
          Properties:
            Path: /bookings/activate
            Method: post
  ReturnScooterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.ReturnScooterHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TableName
      - Statement:
          Effect: Allow
          Action:
          - cognito-idp:AdminGetUser
          - cognito-idp:ListUsers
          Resource:
            Ref: UserPoolArn
      Events:
        UpdateForReturnScooterBooking:
          Type: Api
          Properties:
            Path: /bookings/return
            Method: put
  GetUserInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://sam-bookings-adam/a4866939c8d8c0aaecbfe428101cbf44
      Handler: com.wirelessiths.handler.GetUserInfoHandler::handleRequest
      Runtime: java8
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: TableName
      Events:
        GetUserInfo:
          Type: Api
          Properties:
            Path: /bookings/getuserinfo
            Method: GET
  MyCognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Ref: CognitoUserPoolName
      Policies:
        PasswordPolicy:
          MinimumLength: 8
      UsernameAttributes:
      - email
      Schema:
      - AttributeDataType: String
        Name: email
        Required: false
  MyCognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId:
        Ref: MyCognitoUserPool
      ClientName:
        Ref: CognitoUserPoolClientName
      GenerateSecret: false
  BookingsDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Ref: TableName
      AttributeDefinitions:
      - AttributeName: scooterId
        AttributeType: S
      - AttributeName: endTime
        AttributeType: S
      - AttributeName: bookingId
        AttributeType: S
      - AttributeName: userId
        AttributeType: S
      - AttributeName: date
        AttributeType: S
      - AttributeName: startTime
        AttributeType: S
      KeySchema:
      - AttributeName: scooterId
        KeyType: HASH
      - AttributeName: endTime
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      GlobalSecondaryIndexes:
      - IndexName: userIndex
        KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: startTime
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
      - IndexName: bookingIndex
        KeySchema:
        - AttributeName: bookingId
          KeyType: HASH
        - AttributeName: startTime
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
      - IndexName: dateIndex
        KeySchema:
        - AttributeName: date
          KeyType: HASH
        - AttributeName: scooterId
          KeyType: RANGE
        Projection:
          ProjectionType: ALL
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
Outputs:
  GetBookingFunction:
    Description: GetBooking Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetBookingFunction
      - Arn
  ListBookingFunction:
    Description: ListBooking Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ListBookingFunction
      - Arn
  ListBookingsByUserFunction:
    Description: ListBookingsByUser Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ListBookingsByUserFunction
      - Arn
  DeleteBookingFunction:
    Description: DeleteBooking Lambda Function ARN
    Value:
      Fn::GetAtt:
      - DeleteBookingFunction
      - Arn
  CreateBookingFunction:
    Description: CreateBooking Lambda Function ARN
    Value:
      Fn::GetAtt:
      - CreateBookingFunction
      - Arn
  UpdateBookingFunction:
    Description: UpdateBooking Lambda Function ARN
    Value:
      Fn::GetAtt:
      - UpdateBookingFunction
      - Arn
  ActivateBookingFunction:
    Description: Activate Booking Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ActivateBookingFunction
      - Arn
  ReturnScooterFunction:
    Description: ReturnScooter Lambda Function ARN
    Value:
      Fn::GetAtt:
      - ReturnScooterFunction
      - Arn
  GetUserInfoFunction:
    Description: GetUserInfo Lambda Function ARN
    Value:
      Fn::GetAtt:
      - GetUserInfoFunction
      - Arn
